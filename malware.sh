#!/bin/bash
# Purpose: Remove malware and update WordPress core, flush cache, and clear Redis cache
# Author: Jahanzaib Khan | Cloudways
# Last Edited: 26/04/2024:07:02
# Usage: curl -s https://raw.githubusercontent.com/jahanzaibakhan/scripts/main/malware.sh | bash

# Function to search and rename .htaccess files
search_and_rename_htaccess() {
    local dir="$1"
    if [ -f "$dir/.htaccess" ]; then
        echo "Found .htaccess in $dir"
        mv "$dir/.htaccess" "$dir/.htaccess-bak"
        echo "Renamed to $dir/.htaccess-bak"
    fi
}

# Function to create a new .htaccess file with WordPress code
create_new_htaccess() {
    local dir="$1"
    local code="# BEGIN WordPress

RewriteEngine On
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]

# END WordPress"

    echo -e "$code" > "$dir/.htaccess"
    echo "Created new .htaccess in $dir"
}

# Function to get WordPress core version
get_wordpress_core_version() {
    local version=$(wp core version)
    echo "$version"
}

# Function to flush cache
flush_cache() {
    wp cache flush
    redis-cli flushall
}

# Get WordPress core version
core_version=$(get_wordpress_core_version)
echo "WordPress core version: $core_version"

# Search and rename .htaccess in the root directory (public_html)
search_and_rename_htaccess "."

# Search and rename .htaccess in wp-content, wp-includes, and wp-admin directories
search_and_rename_htaccess "wp-content"
search_and_rename_htaccess "wp-includes"
search_and_rename_htaccess "wp-admin"

# Create a new .htaccess in the root directory (public_html) with WordPress code
create_new_htaccess "."

# Execute the 'wp core download --version' command to update WordPress core to the detected version
wp core download --version="$core_version" --skip-content --force

# Flush cache and clear Redis cache
flush_cache

rm -rf ./malware-removal.sh
exit
